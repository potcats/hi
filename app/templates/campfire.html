<!DOCTYPE html>

<!--
Carrie Ko, Christine Chen, Cindy Liu, Joyce Lin
hi
SoftDev
P02: Makers Makin' It, Act I
01/16/2026
-->

<html>

<head>

  <title> CAMPFIRE </title>

  <!-- CUSTOM CSS -->
  <link rel="stylesheet"
    type="text/css"
    href="/static/css/style.css">

  <!-- BOOTSTRAP CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

  <!-- PAGE SPECIFIC CSS -->
  <style>
    /* BACKGROUND */
    body {
      background-image: url("/static/images/bgs/campsite.jpg");
      background-repeat: no-repeat;
      background-size: 100vw 100vh;

      font-family: font;
    }

    /* TURN INDICATOR */
    #turn {
      position: absolute;

      top: 0;
      right: 10px;

      color: Gainsboro;
    }

    /* MODAL STUFF */
    .mod {
      display: none;
    }

    #close {
      position: absolute;
      bottom: 2.7em;
      left: 10px;

      width: 23%;
      height: 10%;

      border-style: solid;
      border-width: thick;
      border-color: dimgrey;

      background-color: grey
    }

    #sell {
      position: absolute;
      bottom: 2.7em;

      width: 23%;
      height: 10%;

      border-style: solid;
      border-width: thick;
      background-color: firebrick;
    }

    #sell:hover {
      filter: brightness(120%);
    }

    #pts {
      width: 10em;
      height: 2.5em;
      background-color: grey;
    }

    #close:hover, #next:hover,
    .inv:hover:not(.sellable),
    .inspect:hover, #pts:hover,
    #confirm:hover {
      filter: brightness(120%);;
    }

    /* INVENTORY STUFF */
    #bp {
      width: 100px;
      height: auto;

      position: absolute;
      top: 3em;
      right: 10px;
    }

    #bp:hover {
      transform: scale(125%);
    }

    #inv {
      width: 50%;
      height: 95vh;
      padding: 20px;
      padding-bottom: 10px;

      background-color: dimgrey;
    }

    .inv {
      width: 100%;
      height: 10vh;

      margin-bottom: 1em;

      font-size: 125%;

      border-style: none;
      background-color: grey;
    }

    .sellable {
      background-color: firebrick;
    }

    .sellable:hover {
      filter: brightness(120%);
    }

    .inspect {
      position: relative;
      bottom: 20px;
      left: 68%;

      width: 30%;
      font-size: 140%;

      border-style: none;
      background-color: grey
    }

    /* LEVELS + GENERAL STATS CONTAINER */
    #levelsOut {
      width: 23%;
      padding: 5px;
      padding-bottom: 0;

      position: absolute;
      top: 4em;
      left: 10px;

      background-color: dimgrey;
    }

    #levelsIn {
      width: 90%;

      margin-top: 1em;
      margin-right: 15px;

      background-color: grey;
    }

    /* EQUIPMENT DISPLAY */
    #equippedOut {
      width: 23%;
      height: 70%;
      padding: 15px 25px 5px 25px;

      position: absolute;
      top: 4em;
      right: 10px;

      background-color: dimgrey;
    }

    .row {
      height: 25%;
    }

    .square {
      margin-bottom: 10px;

      text-align: center;
      font-size: 110%;

      background-color: grey;
    }

    .square:hover {
      filter: brightness(110%);
    }

    .square:hover text {
      filter: brightness(90%);
    }

    /* PROCEED BUTTON */
    #next {
      position: absolute;
      bottom: 1.5em;
      right : 20px;

      width: 15%;
      height: 10%;

      border-style: solid;
      border-width: thick;
      border-color: dimgrey;

      background-color: grey
    }

    /* POINT ALLOCATION */
    #allocate {
      position: absolute;
      z-index: 1;

      left: 50%;
      top: 40%;
      transform: translate(-50%, -50%);

      background-color: dimgrey;
    }

    .hiding {
      display: none;
    }

    #confirm {
      width: 30%;

      font-size: 140%;

      border-style: none;
      background-color: grey;
    }

    .arrows {
      background: none;
      font-size: 120%;
    }

    #stats {
      font-size: 130%;
    }

  </style>

</head>

<body>
  <!-- AUDIO -->
  <audio loop id="bgm" src="/static/sound/campsite.mp3"> </audio>

  <input type="checkbox" id="audio" onclick="Aud()" style="border-style: none;">
  <label id='audiobut' for="audio">
    <img style="width: 50px; height: auto; position: absolute; left: 5px; top: -6px; filter: invert(80%);"
      src="/static/images/icons/mute.png">
  </label>

  <!-- TURN INDICATOR -->
  <h2 id="turn"> TURN {{ currTurn }}/4 </h2>

  <!-- NEXT ENCOUNTER BUTTON -->
  <button onclick="window.location.href='encounters'" id="next">
    CONTINUE
  </button>

  <!-- INVENTORY BUTTON -->
  <button id="bpbut" onclick="openMod()" style="border-style: none; background: none;">
    <img src="/static/images/icons/backpack.png" id="bp">
  </button>

  <!-- MODAL CLOSE BUTTON -->
  <button class="mod" onclick="closeMod()" id="close" style="left: 10px;">
    CLOSE
  </button>

  <!-- SELL BUTTON -->
  <button class="mod" onclick="toggleSellMode()" id="sell" style="right: 10px;">
    SELL
  </button>

  <!-- LEVELS + GENERAL STATS -->
  <div class="container mod" id="levelsOut">
    <div class="container" id="levelsIn">
      <h3 style="text-align: center; margin-top: 10px;"> {{ username }} </h3>
      <text id='hp'> HP: {{ HP }}/{{ maxHP + con }} </text> <br>
      <text> Level: {{ lvl }} </text> <br>
      <text id='gold'> Gold: {{ gold }} </text> <br>
      <br>
      <text id='str'> STR: {{ str }} </text> <br>
      <text id='dex'> DEX: {{ dex }} </text> <br>
      <text id='con'> CON: {{ con }} </text> <br>
      <text id='int'> INT: {{ int }} </text> <br>
      <text id='fth'> FTH: {{ fth }} </text> <br>
      <text id='lck'> LCK: {{ lck }} </text> <br>
      <br>
      <!-- temp range -->
      <text> INITIATIVE: 4 -- 7 </text> <br>
      <br>
      <button id="pts" onclick="openAllo()"> POINTS ({{ statPoints }}) </button>
      <br><br>
    </div>
    <br>
  </div>

  <!-- MAIN INVENTORY -->
  <div class="container mod" id="inv">
    <div class="container overflow-auto" id="invInner" style="height: 60%">
      {% for item in inventory %}
        {% if inventory[item][1] == "consumable" %}
          <button class="center inv {{ item }}" onclick="clicked(this)"> {{ inventory[item][2] }}x {{ item }} </button>
        {% else %}
          {% for i in range(0, inventory[item][2]|int) %}
            <button class="center inv {{ item }}" onclick="clicked(this)"> {{ item }} </button>
          {% endfor %}
        {% endif %}
      {% endfor %}
    </div>
    <div class="container" id="inspect" style="height: 40%; border-top: solid medium; border-color: #545454">
      <div class="container overflow-auto" style="height: 90%; padding: 15px; font-size: 130%">
        <!-- IF NO ITEMS SELECTED -->
        <h3 style="text-align: center; display: none;" id="noInspect">
          SELECT AN ITEM TO INSPECT
        </h3>

        <!-- ITEMS SELECTED -->
        <h3 id="itemName"> </h3>
        <div id="extension"> </div>
      </div>
      <div class="container" style="height: 10%">
        <!-- SELL BUTTON -->
        <button class="inspect" id="inspectSell" onclick="sell()" style="display: none">
          SELL
        </button>

        <!-- USE BUTTON -->
        <button class="inspect" id="inspectUse" onclick="use()" style="display: none">
          USE
        </button>

        <!-- SELL BUTTON -->
        <button class="inspect" id="inspectEquip" onclick="equip()" style="display: none">
          EQUIP
        </button>
      </div>
    </div>
  </div>

  <!-- EQUIPMENT DISPLAY -->
  <div class="container mod" id="equippedOut">
    {% set equipArr = [["accessory1", "accessory2"],
                        ["accessory3", "helmet"],
                        ["chestplate", "pants"],
                        ["boots", "weapon"]] %}
    {% for row in equipArr %}
      <div class="row" style="gap:10px;">
        {% for e in row %}
          {% if "accessory" in e %}
            <div class="col square" onclick="unequip(this.id)" id="{{ e }}">
              <text style="color: #a1a1a1"> accessory </text>
            </div>
          {% else %}
            <div class="col square" onclick="unequip(this.id)" id="{{ e }}">
              <text style="color: #a1a1a1"> {{ e }} </text>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <!-- ALLOCATE POINTS DISPLAY -->
  <div class="hiding" id="blackout" style="position: absolute; z-index: 0;
                            top: 0; background-color:black; height:100vh;
                            width: 100vw; filter: opacity(50%)">
  </div>

  <div class="container allocate hiding" style="padding: 20px;" id="allocate">
    <div class="row">
      <h3 style="text-align: center" id="allHeading"> POINTS: {{ statPoints }} </h3>
      <br><br>
      <hr>
    </div>
    <br>
    <div class="row" id="up">
      {% for i in range(0,6) %}
        <div class="col">
          <button type="button" id ='u{{ loop.index0 }}'
                  onclick="increment(this.id)" class="bi bi-chevron-up arrows center" disabled>
          </button>
        </div>
      {% endfor %}
    </div>
    <br>
    <div class="row" id="stats">
      <div class="col" style="text-align: center" id='STR'> STR <br> ({{ str }}) </div>
      <div class="col" style="text-align: center" id='DEX'> DEX <br> ({{ dex }}) </div>
      <div class="col" style="text-align: center" id='CON'> CON <br> ({{ con }}) </div>
      <div class="col" style="text-align: center" id='INT'> INT <br> ({{ int }}) </div>
      <div class="col" style="text-align: center" id='FTH'> FTH <br> ({{ fth }}) </div>
      <div class="col" style="text-align: center" id='LCK'> LCK <br> ({{ lck }}) </div>
    </div>
    <br>
    <div class="row" id="down">
      {% for i in range(0,6) %}
        <div class="col">
          <button type="button" id ='d{{ loop.index0 }}'
                  onclick="increment(this.id)" class="bi bi-chevron-down arrows center" disabled>
          </button>
        </div>
      {% endfor %}
    </div>
    <br>
    <div class="row" id="closeAll" style="margin-top:20px">
      <button class="center" onclick="closeAllo()" id="confirm"> CONFIRM </button>
    </div>
  </div>

  <!-- BOOTSTRAP JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"> </script>

  <!-- CUSTOM JS -->
  <script src="/static/js/audio.js"> </script>

  <!-- PAGE-SPECIFIC JS -->
  <script>
    var inv = {{ inventory | tojson }};
    var selectedItm = "";
    var sellMode = false;
    var equipped = {{ equips | tojson }};
    var points = {{ statPoints }};
    var statChanges = [0,0,0,0,0,0];

    /* EVENTS THAT WILL OCCUR ON LOAD */
    window.onload = function() {
      document.getElementById('sell').style.borderColor = "darkred";

      for (items in inv) {
        if (Object.values(equipped).includes(items)) {
          document.getElementsByClassName(items)[0].style.display = "none";
        }
      }

      if (points > 0) {
        for (button of document.getElementsByClassName("bi-chevron-up")) {
          button.disabled = false;
        }
      }
    };

    /* OPEN MODAL */
    function openMod() {
      modalWindows = document.getElementsByClassName("mod");

      for (modal of modalWindows) {
        modal.style.display = "block";
      }

      document.getElementById('close').style.display = "block";
      document.getElementById('next').style.display = "none";

      document.getElementById('noInspect').style.display = "block";

      document.getElementById('bpbut').style.display = "none";

      displayEquips()
    }

    /* CLOSE MODAL */
    function closeMod() {
      selectedItm = "";
      modalWindows = document.getElementsByClassName("mod");

      for (modal of modalWindows) {
        modal.style.display = "none";
      }

      document.getElementById('close').style.display = "none";
      document.getElementById('next').style.display = "block";

      document.getElementById("inspectSell").style.display = "none";
      document.getElementById("inspectUse").style.display = "none";
      document.getElementById("inspectEquip").style.display = "none";

      document.getElementById('bpbut').style.display = "block";

      document.getElementById('itemName').innerHTML = "";
      document.getElementById('extension').innerHTML = "";

      if (sellMode) { toggleSellMode() };
      selectedItm = "";

      cont = document.getElementById("charIn");
      for (img of document.getElementsByClassName("gear")) {
        cont.removeChild(img);
      }

    }

    /* SELL MODE */
    function toggleSellMode() {
      items = document.getElementsByClassName("inv");
      sellBut = document.getElementById('sell')

      if (sellMode) {
        sellMode = false;
        sellBut.style.backgroundColor = "firebrick"
        sellBut.style.borderColor = "darkred"

        for (item of items) {
          item.classList.remove("sellable");
        }

        if (selectedItm != "") {
          document.getElementById("inspectSell").style.display = "none"
          if (inv[selectedItm][1] == "consumable") {
            document.getElementById("inspectUse").style.display = "block"
          } else {
            document.getElementById("inspectEquip").style.display = "block"
          };
        }
      } else {
        sellMode = true;
        sellBut.style.backgroundColor = "forestgreen"
        sellBut.style.borderColor = "darkgreen"

        for (item of items) {
          item.classList.add("sellable");
        }

        if (selectedItm != "") {
          document.getElementById("inspectSell").style.display = "block"
          document.getElementById("inspectUse").style.display = "none";
          document.getElementById("inspectEquip").style.display = "none";
        }
      }
    }

    /* ITEM INTERACTIONS */
    function clicked(itm) {
      let select = new XMLHttpRequest();
      name = Array.from(itm.classList).slice(2).join(" ");

      aaa = name.split(" ");
      if (aaa[aaa.length-1] == "sellable") { name = aaa.slice(0).join(" ") }
      selectedItm = name;

      // console.log(name);

      document.getElementById('noInspect').style.display = "none";
      document.getElementById('itemName').innerHTML = inv[name][0];

      document.getElementById("inspectSell").style.display = "none"
      document.getElementById("inspectUse").style.display = "none";
      document.getElementById("inspectEquip").style.display = "none";

      if (inv[name][1] == "consumable") {
        let effects = "";

        select.open('POST', window.location.href, true);
        select.setRequestHeader("select", "consumable," + name);
        select.send();

        document.getElementById('itemName').innerHTML += " (CONSUMABLE)";
        cont = document.getElementById("extension");
        textExtension = "<h4> EFFECTS </h4><hr>";

        select.onload = function() {
          if (this.readyState == 4 && this.status == 200) {
            effect = this.response;
          }

          textExtension += "<text> HP: " + effect + "</text><br><br>";
          textExtension += "<text> COST: " + inv[selectedItm][3] + "</text><br>";
          cont.innerHTML = textExtension;
        };

        if (sellMode) { document.getElementById("inspectSell").style.display = "block" }
        else { document.getElementById("inspectUse").style.display = "block" };
      } else {
        let stats = "";

        select.open('POST', window.location.href, true);
        select.setRequestHeader("select", "gear," + name);
        select.send();

        document.getElementById('itemName').innerHTML += " (GEAR)";
        cont = document.getElementById("extension");
        textExtension = "<h4> STATS </h4><hr>";

        select.onload = function() {
          if (this.readyState == 4 && this.status == 200) {
            stats = JSON.parse(this.response);
          }

          textExtension += "<text> STR: " + stats[0] + "</text><br>";
          textExtension += "<text> DEX: " + stats[1] + "</text><br>";
          textExtension += "<text> CON: " + stats[2] + "</text><br>";
          textExtension += "<text> INT: " + stats[3] + "</text><br>";
          textExtension += "<text> FTH: " + stats[4] + "</text><br>";
          textExtension += "<text> LCK: " + stats[5] + "</text><br><br>";
          textExtension += "<text> COST: " + inv[selectedItm][3] + "</text><br>";

          cont.innerHTML = textExtension;
        };

        if (sellMode) { document.getElementById("inspectSell").style.display = "block" }
        else { document.getElementById("inspectEquip").style.display = "block" };
      }
    }

    function sell() {
      let newGold = "";
      let sell = new XMLHttpRequest();

      sell.open('POST', window.location.href, true);
      sell.setRequestHeader("sell", selectedItm);
      sell.send();

      sell.onload = function() {
        if (this.readyState == 4 && this.status == 200) {
          newGold = parseInt(this.response);
        }

        inv[selectedItm][2] = (parseInt(inv[selectedItm][2]) - 1).toString();

        if (inv[selectedItm][1] == "consumable") {
          if (parseInt(inv[selectedItm][2]) == 0) {
            document.getElementsByClassName(selectedItm)[0].remove()
          } else {
            document.getElementsByClassName(selectedItm)[0].innerHTML = `${inv[selectedItm][2]}x ${selectedItm}`
          }
        } else {
          document.getElementsByClassName(selectedItm)[0].remove()
        }

        document.getElementById('gold').innerHTML = `GOLD: ${newGold}`;
      }
    }

    function use() {
      let use = new XMLHttpRequest();
      use.open('POST', window.location.href, true);
      use.setRequestHeader("use", selectedItm);
      use.send();

      use.onload = function() {
        updateStats();

        inv[selectedItm][2] = (parseInt(inv[selectedItm][2]) - 1).toString();
        if (parseInt(inv[selectedItm][2]) == 0) {
          document.getElementsByClassName(selectedItm)[0].remove()
        } else {
          document.getElementsByClassName(selectedItm)[0].innerHTML = `${inv[selectedItm][2]}x ${selectedItm}`
        }
      }
    }

    function equip() {
      let equip = new XMLHttpRequest();
      equip.open('POST', window.location.href, true);
      equip.setRequestHeader("equip", selectedItm);
      equip.send();

      equip.onload = function() {
        if (this.readyState == 4 && this.status == 200) {
          equipped = JSON.parse(this.response);
        }

        document.getElementsByClassName(selectedItm)[0].style.display = "none";
        displayEquips();
        updateStats();
      };
    }

    function unequip(itm) {
      let g = equipped[itm];

      if (g == "") {
        return;
      }

      let unequip = new XMLHttpRequest();
      unequip.open('POST', window.location.href, true);
      unequip.setRequestHeader("unequip", itm);
      unequip.send();

      unequip.onload = function() {
        if (this.readyState == 4 && this.status == 200) {
          equipped = JSON.parse(this.response);
        }

        document.getElementsByClassName(g)[0].style.display = "block";
        displayEquips();
        updateStats();
      };
    }

    function displayEquips() {
      for (gear in equipped) {
        if (equipped[gear] != "") {
          if (document.getElementById(gear).innerHTML.includes("<br>")) {
            if (!document.getElementById(gear).innerHTML.includes(equipped[gear])) {
              let og = document.getElementById(gear).innerHTML.split("<br><br>");

              document.getElementById(gear).innerHTML = og[0] + "<br><br>" + equipped[gear];
              document.getElementsByClassName(og[1])[0].style.display = "block";
            }
          } else {
            document.getElementById(gear).innerHTML += "<br><br>" + equipped[gear];
          }
        } else if (document.getElementById(gear).innerHTML.includes("<br>")) {
          document.getElementById(gear).innerHTML = document.getElementById(gear).innerHTML.split("<br><br>")[0];
        }
      }
    }

    function updateStats() {
      let stats = "";

      let update = new XMLHttpRequest();
      update.open('POST', window.location.href, true);
      update.setRequestHeader("stats", 'aaaaaaaa');
      update.send();

      update.onload = function() {
        if (this.readyState == 4 && this.status == 200) {
          stats = JSON.parse(this.response);
        }

        maxhp = {{ maxHP }} + stats[4];
        document.getElementById('hp').innerHTML = `HP: ${stats[1]}/${ maxhp }`;
        document.getElementById('str').innerHTML = `STR: ${stats[2]}`;
        document.getElementById('dex').innerHTML = `DEX: ${stats[3]}`;
        document.getElementById('con').innerHTML = `CON: ${stats[4]}`;
        document.getElementById('int').innerHTML = `INT: ${stats[5]}`;
        document.getElementById('fth').innerHTML = `FTH: ${stats[6]}`;
        document.getElementById('lck').innerHTML = `LCK: ${stats[7]}`;
      }
    }

    /* POINT ALLOCATION */
    function openAllo() {
      document.getElementById("allocate").classList.remove("hiding");
      document.getElementById("blackout").classList.remove("hiding");
    }

    function closeAllo() {
      let close = new XMLHttpRequest();
      close.open("POST", window.location.href, true);
      close.setRequestHeader("points", JSON.stringify(statChanges));
      close.send();

      close.onload = function() {
        if (this.readyState == 4 && this.status == 200) {
          newPts = parseInt(this.response);
        }

        document.getElementById('pts').innerHTML = `POINTS (${newPts})`;
        updateStats();
        statChanges = [0,0,0,0,0,0];

        document.getElementById("allocate").classList.add("hiding");
        document.getElementById("blackout").classList.add("hiding");

        for (button of document.getElementsByClassName("bi-chevron-down")) {
          button.disabled = true;
        }
      }
    }

    function increment(id) {
      console.log(points);
      statTypes = ['STR', 'DEX', 'CON', 'INT', 'FTH', 'LCK']
      let dir = id[0];
      let index = parseInt(id[1])
      let stat = statTypes[index];

      cont = document.getElementById(stat);
      values = cont.innerHTML.split("<br>");
      og = parseInt(values[1].trim().slice(1,values[1].length-1));

      incr = 1;
      if (dir == 'd') { incr = -1 };

      cont.innerHTML = `${values[0]} <br> (${og + incr})`;
      points -= incr;
      statChanges[index] += incr;

      document.getElementById('allHeading').innerHTML = `POINTS: ${points}`;

      if (dir == 'u') {
        if (document.getElementById(`d${index}`).disabled) {
          document.getElementById(`d${index}`).disabled = false;
        }
        if (points == 0) {
          for (button of document.getElementsByClassName("bi-chevron-up")) {
            button.disabled = true;
          }
        }
      }
      else if (dir == 'd') {
        if (statChanges[index] == 0) {
          document.getElementById(`d${index}`).disabled = true;
        }
        if (document.getElementById(`u${index}`).disabled) {
          for (button of document.getElementsByClassName("bi-chevron-up")) {
            button.disabled = false;
          }
        }
      }
    }

  </script>

</body>

</html>
